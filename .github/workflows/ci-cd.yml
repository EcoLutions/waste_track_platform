name: CI/CD Pipeline - Waste Track Platform

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, closed ]
  push:
    branches: [ main ]

env:
  JAVA_VERSION: '25'
  IMAGE_NAME: jhosepmyr/waste-track-platform

jobs:
  test:
    name: ðŸ§ª Tests & Quality Checks
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: ðŸ” Validate pom.xml
        run: mvn validate

      - name: ðŸ§ª Run Unit Tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: test_db
          DB_USER: test_user
          DB_PASS: test_pass
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          FIREBASE_CONFIG: '${{ secrets.FIREBASE_CONFIG }}'
          FIREBASE_BUCKET: ${{ secrets.FIREBASE_BUCKET }}
        run: mvn test -B
        continue-on-error: false

      - name: ðŸ§ª Run Integration Tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: test_db
          DB_USER: test_user
          DB_PASS: test_pass
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          FIREBASE_CONFIG: '${{ secrets.FIREBASE_CONFIG }}'
          FIREBASE_BUCKET: ${{ secrets.FIREBASE_BUCKET }}
        run: mvn verify -DskipUnitTests -B
        continue-on-error: false

  build-and-push:
    name: ðŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: |
      (github.event_name == 'pull_request' && 
       github.event.action == 'closed' && 
       github.event.pull_request.merged == true) ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    outputs:
      version: ${{ steps.extract-version.outputs.version }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: ðŸ” Extract version from pom.xml
        id: extract-version
        run: |
          echo "ðŸ“‹ Extracting version from pom.xml..."
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "âœ… Version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: ðŸ” Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u jhosepmyr --password-stdin

      - name: ðŸ³ Build & Push Docker Image
        run: |
          echo "ðŸ—ï¸ Building Docker image with Spring Boot buildpacks..."
          mvn spring-boot:build-image -DskipTests "-DdockerPassword=${{ secrets.DOCKER_PASSWORD }}"
          
          echo "âœ… Image built successfully!"
          
          # Tag como latest
          docker tag "${{ env.IMAGE_NAME }}:${{ steps.extract-version.outputs.version }}" "${{ env.IMAGE_NAME }}:latest"
          
          # Push ambos tags
          echo "ðŸ“¤ Pushing images to Docker Hub..."
          docker push "${{ env.IMAGE_NAME }}:${{ steps.extract-version.outputs.version }}"
          docker push "${{ env.IMAGE_NAME }}:latest"
          
          echo "âœ… Images pushed successfully!"

      - name: ðŸ“‹ Image Summary
        run: |
          echo "### ðŸ³ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.extract-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** " >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME }}:${{ steps.extract-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY